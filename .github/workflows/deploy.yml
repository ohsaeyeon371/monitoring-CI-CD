name: build-and-deploy

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: test-app

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.vars.outputs.image }}
      tag: ${{ steps.vars.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Vars
        id: vars
        run: |
          echo "image=ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
          echo "tag=sha-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.tag }}
            ${{ steps.vars.outputs.image }}:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest

    env:
      NCLOUD_ACCESS_KEY: ${{ secrets.NCLOUD_ACCESS_KEY }}
      NCLOUD_SECRET_KEY: ${{ secrets.NCLOUD_SECRET_KEY }}
      NAMESPACE: ${{ secrets.NAMESPACE }}

    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Install ncp-iam-authenticator
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL -o ncp-iam-authenticator \
            https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/latest/download/ncp-iam-authenticator_linux_amd64
          chmod +x ncp-iam-authenticator
          sudo mv ncp-iam-authenticator /usr/local/bin/
          ncp-iam-authenticator version

      - name: Setup kubeconfig
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.kube
          printf '%s' "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      # ✅ 핵심: 대화형 입력(EOF) 막기 위해 ~/.ncloud/configure를 런타임 생성
      - name: Write NCP credential file (non-interactive)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ncloud

          # secrets 비어있으면 바로 실패 (값 노출 없이 길이만 체크)
          echo "AK_LEN=${#NCLOUD_ACCESS_KEY} SK_LEN=${#NCLOUD_SECRET_KEY}"

          if [ -z "${NCLOUD_ACCESS_KEY:-}" ] || [ -z "${NCLOUD_SECRET_KEY:-}" ]; then
            echo "NCLOUD secrets missing. Set NCLOUD_ACCESS_KEY / NCLOUD_SECRET_KEY in GitHub Secrets."
            exit 1
          fi

          cat > ~/.ncloud/configure << EOF
[DEFAULT]
ncloud_access_key_id=${NCLOUD_ACCESS_KEY}
ncloud_secret_access_key=${NCLOUD_SECRET_KEY}
ncloud_region=KR
ncloud_api_url=https://ncloud.apigw.ntruss.com
EOF
          chmod 600 ~/.ncloud/configure

      - name: Cluster reachability check
        shell: bash
        run: |
          set -euo pipefail
          kubectl --request-timeout=10s get --raw=/readyz

      - name: Ensure namespace
        shell: bash
        run: |
          set -euo pipefail
          kubectl get ns "$NAMESPACE" >/dev/null 2>&1 || kubectl create ns "$NAMESPACE"

      - name: Deploy manifests
        shell: bash
        run: |
          set -euo pipefail
          kubectl -n "$NAMESPACE" apply -f k8s/

      - name: Update image & rollout
        shell: bash
        run: |
          set -euo pipefail
          kubectl -n "$NAMESPACE" set image deploy/test-app nginx=${{ needs.build.outputs.image }}:${{ needs.build.outputs.tag }}
          kubectl -n "$NAMESPACE" rollout status deploy/test-app --timeout=180s
